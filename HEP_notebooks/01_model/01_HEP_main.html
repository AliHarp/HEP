

<!DOCTYPE html>


<html >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>SimPy Model for elective orthopaedic theatre and ward planning &#8212; Hospital Efficiency Project Orthopaedic Planning Model</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'HEP_notebooks/01_model/01_HEP_main';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Scenario Testing" href="02_Scenario_testing.html" />
    <link rel="prev" title="Hospital Efficiency Project" href="../01_intro.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="None"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../01_intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../../_static/HdRlogo.jpg" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../_static/HdRlogo.jpg" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../01_intro.html">
                    Hospital Efficiency Project
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">RUNNING THE MODEL</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">SimPy Model for elective orthopaedic theatre and ward planning</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_Scenario_testing.html">Scenario Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_Scenarios_paper.html">Scenario analysis for BMJ Open paper</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_HEP_fit_dists.html">Fitting LoS distributions for HEP</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">REPORTING GUIDELINES</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../02_STRESS/STRESS_DES.html">STRESS-DES</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/AliHarp/HEP/main?urlpath=lab/tree/HEP_notebooks/01_model/01_HEP_main.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/AliHarp/HEP" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/AliHarp/HEP/issues/new?title=Issue%20on%20page%20%2FHEP_notebooks/01_model/01_HEP_main.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/HEP_notebooks/01_model/01_HEP_main.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>SimPy Model for elective orthopaedic theatre and ward planning</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#packages">1. Packages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#baseline-parameters">2. Baseline parameters</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#initialise-start-date">2.1 Initialise start date</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fitted-baseline-parameters-for-nbt-based-on-electronic-health-records-2016-2019">2.2 Fitted baseline parameters for NBT based on electronic health records 2016-2019</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">2.3 Baseline parameters</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#trace-utility">3. Trace utility</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#distribution-classes">4. Distribution classes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#theatre-schedule">4. Theatre schedule</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-parameterisation">5. Model parameterisation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#patient-pathways-process-logic">6. Patient pathways process logic</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-model-class">7. The model class</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary-results-across-days-and-runs">8. Summary results across days and runs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-execution">9. Model execution</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-single-run">9.1 A single run</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multiple-independent-replications">9.2 Multiple independent replications</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-summary-results-for-multiple-runs">9.3 Plot summary results for multiple runs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary-results-per-day-for-multiple-runs-for-bed-utilisation">10. Summary results per day for multiple runs for bed utilisation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary-results-per-day-for-multiple-runs">11. Summary results per day for multiple runs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#patient-level-results-summarised-by-day-and-weekday">12. Patient level results summarised by day and weekday</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#more-plots">13. MORE plots</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hists-of-outputs">hists of outputs</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="simpy-model-for-elective-orthopaedic-theatre-and-ward-planning">
<h1>SimPy Model for elective orthopaedic theatre and ward planning<a class="headerlink" href="#simpy-model-for-elective-orthopaedic-theatre-and-ward-planning" title="Permalink to this headline">#</a></h1>
<p>The aim of this discrete-event simulation (DES) model is to support orthopaedic elective theatre and ward planning.</p>
<p>The DES model enables experimentation with the theatre schedule, number of beds, lengths-of-stay for five orthopaedic elective surgery types, the proportion of patients with a delayed discharge, and the length of delay.</p>
<p>The simulation model is intended to support capacity planning of orthopaedic elective services
by identifying a balance of capacity across theatres and beds and predicting the impact of productivity
measures on capacity requirements. It is applicable beyond the study site and can be adapted for other
specialties.</p>
<section id="packages">
<h2>1. Packages<a class="headerlink" href="#packages" title="Permalink to this headline">#</a></h2>
<p>The model is provided with a conda virtual environment <code class="docutils literal notranslate"><span class="pre">hep_env</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">simpy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">arrow</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">warnings</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="baseline-parameters">
<h2>2. Baseline parameters<a class="headerlink" href="#baseline-parameters" title="Permalink to this headline">#</a></h2>
<section id="initialise-start-date">
<h3>2.1 Initialise start date<a class="headerlink" href="#initialise-start-date" title="Permalink to this headline">#</a></h3>
<p>Initialise start date to a Monday and define it to be equal to the simulation time
This allows monitoring of weekdays</p>
<p>Defined in days: Monday = 0</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="o">=</span> <span class="n">arrow</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;2022-06-27&#39;</span><span class="p">)</span>  
<span class="c1"># start on a monday</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Environment</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fitted-baseline-parameters-for-nbt-based-on-electronic-health-records-2016-2019">
<h3>2.2 Fitted baseline parameters for NBT based on electronic health records 2016-2019<a class="headerlink" href="#fitted-baseline-parameters-for-nbt-based-on-electronic-health-records-2016-2019" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Primary: primary hip, primary knee, primary uni-compartmental knee</p></li>
<li><p>Revision: revision hip, revision knee</p></li>
</ul>
<p>delay_los count    529.000000<br />
*mean      16.521739<br />
*std       15.153132<br />
*min        2.000000<br />
*25%        8.000000<br />
*50%       13.000000<br />
*75%       19.000000<br />
*max      156.000000</p>
<p>primary_knee count    2150.000000<br />
*mean        4.651163<br />
*std         2.828129<br />
*min         0.000000<br />
*25%         3.000000<br />
*50%         4.000000<br />
*75%         6.000000<br />
*max        42.000000</p>
<p>uni_knee count    668.000000<br />
*mean       2.914671<br />
*std        2.136334<br />
*min        0.000000<br />
*25%        2.000000<br />
*50%        3.000000<br />
*75%        4.000000<br />
*max       16.000000</p>
<p>revise_knee count    340.000000<br />
*mean       7.194118<br />
*std        7.598554<br />
*min        0.000000<br />
*25%        3.000000<br />
*50%        5.000000<br />
*75%        9.000000<br />
*max       63.000000</p>
<p>primary_hip count    2820.000000<br />
*mean        4.433333<br />
*std         2.949526<br />
*min         0.000000<br />
*25%         3.000000<br />
*50%         4.000000<br />
*75%         5.000000<br />
*max        44.000000</p>
<p>revise_hip count    406.000000<br />
*mean       6.908867<br />
*std        6.965812<br />
*min        0.000000<br />
*25%        3.000000<br />
*50%        5.000000<br />
*75%        8.000000<br />
*max       86.000000</p>
</section>
<section id="id1">
<h3>2.3 Baseline parameters<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ward parameters</span>
<span class="n">DEFAULT_PRIMARY_HIP_MEAN_LOS</span> <span class="o">=</span> <span class="mf">4.433333</span> 
<span class="n">DEFAULT_PRIMARY_KNEE_MEAN_LOS</span> <span class="o">=</span>  <span class="mf">4.651163</span> 
<span class="n">DEFAULT_REVISION_HIP_MEAN_LOS</span> <span class="o">=</span> <span class="mf">6.908867</span> 
<span class="n">DEFAULT_REVISION_KNEE_MEAN_LOS</span> <span class="o">=</span> <span class="mf">7.194118</span> 
<span class="n">DEFAULT_UNICOMPART_KNEE_MEAN_LOS</span> <span class="o">=</span> <span class="mf">2.914671</span> 

<span class="n">DEFAULT_PRIMARY_HIP_SD_LOS</span> <span class="o">=</span> <span class="mf">2.949526</span>
<span class="n">DEFAULT_PRIMARY_KNEE_SD_LOS</span> <span class="o">=</span> <span class="mf">2.828129</span>
<span class="n">DEFAULT_REVISION_HIP_SD_LOS</span> <span class="o">=</span> <span class="mf">6.965812</span>
<span class="n">DEFAULT_REVISION_KNEE_SD_LOS</span> <span class="o">=</span> <span class="mf">7.598554</span>
<span class="n">DEFAULT_UNICOMPART_KNEE_SD_LOS</span> <span class="o">=</span> <span class="mf">2.136334</span>

<span class="n">DEFAULT_DELAY_POST_LOS_MEAN</span> <span class="o">=</span> <span class="mf">16.521739</span>
<span class="n">DEFAULT_DELAY_POST_LOS_SD</span> <span class="o">=</span> <span class="mf">15.153132</span>

<span class="n">DEFAULT_PROB_WARD_DELAY</span> <span class="o">=</span> <span class="mf">0.076</span>  

<span class="c1"># ward resources</span>
<span class="n">DEFAULT_NUMBER_BEDS</span> <span class="o">=</span> <span class="mi">40</span>

<span class="n">DEFAULT_PRIMARY_DICT</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;p_hip&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;p_knee&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;uni_knee&#39;</span><span class="p">}</span>
<span class="n">DEFAULT_REVISION_DICT</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;r_hip&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;r_knee&#39;</span><span class="p">}</span>
<span class="n">DEFAULT_PRIMARY_PROB</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.51</span><span class="p">,</span> <span class="mf">0.38</span><span class="p">,</span> <span class="mf">0.11</span><span class="p">]</span>
<span class="n">DEFAULT_REVISION_PROB</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.55</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">]</span>

<span class="n">SET_WEEKDAY</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Monday&#39;</span><span class="p">,</span> <span class="s1">&#39;Tuesday&#39;</span><span class="p">,</span> <span class="s1">&#39;Wednesday&#39;</span><span class="p">,</span> <span class="s1">&#39;Thursday&#39;</span><span class="p">,</span>
               <span class="s1">&#39;Friday&#39;</span><span class="p">,</span> <span class="s1">&#39;Saturday&#39;</span><span class="p">,</span> <span class="s1">&#39;Sunday&#39;</span><span class="p">]</span>
<span class="n">SET_SESSIONS_PER_WEEKDAY</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Monday&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;Tuesday&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;Wednesday&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;Thursday&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                            <span class="s1">&#39;Friday&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;Saturday&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Sunday&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
<span class="n">SET_SESSIONS_PER_WEEKDAY_LIST</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">SET_SESSIONS_PER_WEEKDAY</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="n">SET_ALLOCATION</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Monday&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;2P_or_1R&#39;</span><span class="p">,</span> <span class="s1">&#39;2P_or_1R&#39;</span><span class="p">,</span> <span class="s1">&#39;1P&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;Tuesday&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;2P_or_1R&#39;</span><span class="p">,</span> <span class="s1">&#39;2P_or_1R&#39;</span><span class="p">,</span> <span class="s1">&#39;1P&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;Wednesday&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;2P_or_1R&#39;</span><span class="p">,</span> <span class="s1">&#39;2P_or_1R&#39;</span><span class="p">,</span> <span class="s1">&#39;1P&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;Thursday&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;2P_or_1R&#39;</span><span class="p">,</span> <span class="s1">&#39;2P_or_1R&#39;</span><span class="p">,</span> <span class="s1">&#39;1P&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;Friday&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;2P_or_1R&#39;</span><span class="p">,</span> <span class="s1">&#39;2P_or_1R&#39;</span><span class="p">,</span> <span class="s1">&#39;1P&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;Saturday&#39;</span><span class="p">:</span> <span class="p">[],</span>
                  <span class="s1">&#39;Sunday&#39;</span><span class="p">:</span> <span class="p">[]}</span>
<span class="n">SET_THEATRES_PER_WEEKDAY</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Monday&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;Tuesday&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;Wednesday&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;Thursday&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                            <span class="s1">&#39;Friday&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;Saturday&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Sunday&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

<span class="c1"># simulation parameters</span>
<span class="n">DEFAULT_NUMBER_OF_RUNS</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">DEFAULT_RESULTS_COLLECTION_PERIOD</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">results_collection_period</span> <span class="o">=</span> <span class="mi">70</span>
<span class="n">DEFAULT_WARM_UP_PERIOD</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">default_rng_set</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># for returning results per day</span>
<span class="n">first_obs</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">interval</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">TRACE</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># extreme schedule generated for testing</span>
<span class="n">new_schedule</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;Test_data/new_schedule.csv&#39;</span><span class="p">)</span>

<span class="c1"># empirical los distributions for patients not delayed</span>
<span class="n">los_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;Test_data/los_spells_no_zero.csv&#39;</span><span class="p">)</span>
<span class="c1">#convert to np arrays for sampling</span>
<span class="n">primary_knee_los_data</span> <span class="o">=</span> <span class="n">los_data</span><span class="p">[</span><span class="s1">&#39;Primary Knee&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">unicomp_knee_los_data</span> <span class="o">=</span> <span class="n">los_data</span><span class="p">[</span><span class="s1">&#39;Unicompart Knee&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">revision_knee_los_data</span> <span class="o">=</span> <span class="n">los_data</span><span class="p">[</span><span class="s1">&#39;Revision Knee&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">primary_hip_los_data</span> <span class="o">=</span> <span class="n">los_data</span><span class="p">[</span><span class="s1">&#39;Primary Hip&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">revision_hip_los_data</span> <span class="o">=</span> <span class="n">los_data</span><span class="p">[</span><span class="s1">&#39;Revision Hip&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

<span class="c1">#optional use of empirical data to sample los distributions</span>
<span class="n">use_empirical_data</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># later for translation: ignore this - testing</span>
<span class="n">primary_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;p_hip&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;p_knee&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;uni_knee&#39;</span><span class="p">}</span>
<span class="n">revision_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;r_hip&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;r_knee&#39;</span><span class="p">}</span>
<span class="n">primary_prop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
<span class="n">revision_prop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">vec_tran</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">)(</span><span class="n">prop</span><span class="p">)</span>

<span class="c1"># trial sample and vectorize by dict key</span>
<span class="n">primary_sample</span> <span class="o">=</span> <span class="n">vec_tran</span><span class="p">(</span><span class="n">primary_prop</span><span class="p">,</span> <span class="n">primary_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="trace-utility">
<h2>3. Trace utility<a class="headerlink" href="#trace-utility" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used for debugging</span>
<span class="sd">    If TRUE will return all patient level message output</span>
<span class="sd">    Default = FALSE</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">TRACE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="distribution-classes">
<h2>4. Distribution classes<a class="headerlink" href="#distribution-classes" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Used to control random number sampling</p></li>
<li><p>Each distribution has its own stream</p></li>
<li><p>Lognormal for lengths-of-stay</p></li>
<li><p>Bernoulli for determining lost theatres slots and delayed discharges</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Lognormal</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    for creating LoS distributions for each patient type</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">stdv</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_params</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">stdv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">mu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>

    <span class="k">def</span> <span class="nf">calc_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">stdv</span><span class="p">):</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="p">(</span><span class="n">stdv</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">mean</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mean</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">phi</span><span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">phi</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">mean</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="k">return</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span>

    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        method to generate a sample from the lognormal distribution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Bernoulli</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    for pathway branching: slots lost on day, </span>
<span class="sd">    patients whose LoS is delayed due to downstream processes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">random_seed</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;p = prob of drawing a 1&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        method to generate a sample from the Bernoulli distribution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">)</span> 

<span class="k">class</span> <span class="nc">Gamma</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    sensitivity analysis on LoS distributions for each patient type</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">stdv</span><span class="p">,</span> <span class="n">random_seed</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span> <span class="o">=</span> <span class="n">random_seed</span><span class="p">)</span>
        <span class="n">scale</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_params</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">stdv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span>

    <span class="k">def</span> <span class="nf">calc_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">stdv</span><span class="p">):</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">stdv</span> <span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">mean</span> 
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">stdv</span> <span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">scale</span> <span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scale</span><span class="p">,</span> <span class="n">shape</span>

    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        method to generate a sample from the gamma distribution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">)</span>
    
<span class="k">class</span> <span class="nc">Empirical</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    for los distributions not fitting statistical distributions</span>
<span class="sd">    losdata: los per procedure type</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">losdata</span><span class="p">,</span> <span class="n">random_seed</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span> <span class="o">=</span> <span class="n">random_seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">losdata</span> <span class="o">=</span> <span class="n">losdata</span>
        
    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        method to generate a sample from empirical distribution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">losdata</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="theatre-schedule">
<h2>4. Theatre schedule<a class="headerlink" href="#theatre-schedule" title="Permalink to this headline">#</a></h2>
<p>Generates a theatre schedule from baseline settings, and optionally for a user-defined schedule.</p>
<p>Baseline settings:</p>
<ul class="simple">
<li><p>4 theatres (2-6)</p></li>
<li><p>5 day/week (5-7)</p></li>
<li><p>Each theatre has three sessions per day:</p>
<ul>
<li><p>Morning: 1 revision OR 2 primary</p></li>
<li><p>Afternoon: 1 revision OR 2 primary</p></li>
<li><p>Evening: 1 primary</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Schedule</span><span class="p">:</span>
        
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates theatre schedule according to rules</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weekday</span><span class="o">=</span><span class="n">SET_WEEKDAY</span><span class="p">,</span>
                <span class="n">allocation</span><span class="o">=</span><span class="n">SET_ALLOCATION</span><span class="p">,</span>
                <span class="n">sessions_per_weekday</span><span class="o">=</span><span class="n">SET_SESSIONS_PER_WEEKDAY</span><span class="p">,</span>
                <span class="n">sessions_per_weekday_list</span><span class="o">=</span><span class="n">SET_SESSIONS_PER_WEEKDAY_LIST</span><span class="p">,</span>
                <span class="n">theatres_per_weekday</span><span class="o">=</span><span class="n">SET_THEATRES_PER_WEEKDAY</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        parameters used to create schedule defined in &#39;scenarios class&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weekday</span><span class="o">=</span><span class="n">weekday</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocation</span><span class="o">=</span><span class="n">allocation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sessions_per_weekday</span><span class="o">=</span><span class="n">sessions_per_weekday</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sessions_per_weekday_list</span><span class="o">=</span><span class="n">sessions_per_weekday_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theatres_per_weekday</span><span class="o">=</span><span class="n">theatres_per_weekday</span>
        
    <span class="k">def</span> <span class="nf">create_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">weekday</span><span class="p">,</span> <span class="n">sessions_per_weekday_list</span><span class="p">,</span> <span class="n">allocation</span><span class="p">,</span> <span class="n">theatres_per_weekday</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Arguments needed:</span>
<span class="sd">            *weekday: a list of weekdays</span>
<span class="sd">            *sessions_per_weekday: a list of integers representing the number of sessions per weekday</span>
<span class="sd">            *allocation: a dictionary where the keys are the weekdays and the values are lists of </span>
<span class="sd">                        allocations for each session </span>
<span class="sd">            *theatres_per_weekday: a dictionary where the keys are the weekdays and the values are </span>
<span class="sd">                        integers representing the number of theatres per weekday </span>
<span class="sd">        Returns a dictionary where the keys are the weekdays and the values are lists </span>
<span class="sd">                        of lists of allocations for each theatre for each session.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">schedule</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">day</span><span class="p">,</span> <span class="n">num_sessions</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">weekday</span><span class="p">,</span> <span class="n">sessions_per_weekday_list</span><span class="p">):</span>
            <span class="n">schedule</span><span class="p">[</span><span class="n">day</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">theatre</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">theatres_per_weekday</span><span class="p">[</span><span class="n">day</span><span class="p">]):</span>
                <span class="n">schedule</span><span class="p">[</span><span class="n">day</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sessions</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">allocation</span><span class="p">[</span><span class="n">day</span><span class="p">][</span><span class="n">session</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1P&#39;</span><span class="p">:</span>
                        <span class="n">schedule</span><span class="p">[</span><span class="n">day</span><span class="p">][</span><span class="n">theatre</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;primary&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">allocation</span><span class="p">[</span><span class="n">day</span><span class="p">][</span><span class="n">session</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1R&#39;</span><span class="p">:</span>
                        <span class="n">schedule</span><span class="p">[</span><span class="n">day</span><span class="p">][</span><span class="n">theatre</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;revision&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">allocation</span><span class="p">[</span><span class="n">day</span><span class="p">][</span><span class="n">session</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2P&#39;</span><span class="p">:</span>
                        <span class="n">schedule</span><span class="p">[</span><span class="n">day</span><span class="p">][</span><span class="n">theatre</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;primary&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">allocation</span><span class="p">[</span><span class="n">day</span><span class="p">][</span><span class="n">session</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2P_or_1R&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
                            <span class="n">schedule</span><span class="p">[</span><span class="n">day</span><span class="p">][</span><span class="n">theatre</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;primary&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">schedule</span><span class="p">[</span><span class="n">day</span><span class="p">][</span><span class="n">theatre</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;revision&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">schedule</span>
        
    <span class="k">def</span> <span class="nf">daily_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">day_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        day_data: called in week_schedule() function, day_data is a sample weekly dictionary from create_schedule()</span>
<span class="sd">        </span>
<span class="sd">        Convert dict to a pandas DataFrame with &#39;primary&#39; and &#39;revision&#39; as columns </span>
<span class="sd">        and days of the week as the index, populated with the total count of &#39;primary&#39; and &#39;revision&#39; in each day.</span>
<span class="sd">        Returns a one week schedule</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#day_data = create_schedule(weekday, sessions_per_weekday, allocation, theatres_per_weekday)</span>
        <span class="n">primary_slots</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">revision_slots</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">day_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sub_value</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;primary&#39;</span> <span class="ow">in</span> <span class="n">sub_value</span><span class="p">:</span>
                        <span class="n">primary_slots</span> <span class="o">+=</span> <span class="n">sub_value</span><span class="p">[</span><span class="s1">&#39;primary&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;revision&#39;</span> <span class="ow">in</span> <span class="n">sub_value</span><span class="p">:</span>
                        <span class="n">revision_slots</span> <span class="o">+=</span> <span class="n">sub_value</span><span class="p">[</span><span class="s1">&#39;revision&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">primary_slots</span><span class="p">,</span> <span class="n">revision_slots</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">week_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        samples a weekly dictionary of theatres, sessions, and surgeries from create_schedule()</span>
<span class="sd">        counts daily number or primary and revision surgeries needed using daily_counts()</span>
<span class="sd">        and converts to a dataframe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">week_sched</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Primary_slots&#39;</span><span class="p">,</span> <span class="s1">&#39;Revision_slots&#39;</span><span class="p">])</span>
        <span class="n">day_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_schedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weekday</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions_per_weekday_list</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">allocation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theatres_per_weekday</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">day_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">week_sched</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_counts</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">week_sched</span> <span class="o">=</span> <span class="n">week_sched</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">week_sched</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="s1">&#39;Day&#39;</span><span class="p">},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">week_sched</span>

    <span class="k">def</span> <span class="nf">theatre_capacity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">length_sched</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">DEFAULT_WARM_UP_PERIOD</span><span class="o">+</span><span class="n">DEFAULT_RESULTS_COLLECTION_PERIOD</span><span class="p">)</span><span class="o">/</span><span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="n">DEFAULT_SCHEDULE_AVAIL</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">week</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length_sched</span><span class="p">):</span>
            <span class="n">single_random_week</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">week_schedule</span><span class="p">()</span>
            <span class="n">DEFAULT_SCHEDULE_AVAIL</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">DEFAULT_SCHEDULE_AVAIL</span><span class="p">,</span> <span class="n">single_random_week</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DEFAULT_SCHEDULE_AVAIL</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="c1"># class Save:</span>
<span class="c1">#     schedule = Schedule()</span>
<span class="c1">#     def __init__(self, schedule):</span>
<span class="c1">#         self.schedule = schedule</span>
    
<span class="c1">#     schedule_avail3 = schedule.theatre_capacity()</span>
<span class="c1">#     print(schedule_avail3.head(7))</span>
<span class="c1">#     schedule_avail3.to_csv(&#39;data/new_schedule_checking.csv&#39;)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="model-parameterisation">
<h2>5. Model parameterisation<a class="headerlink" href="#model-parameterisation" title="Permalink to this headline">#</a></h2>
<p>A <code class="docutils literal notranslate"><span class="pre">scenarios</span></code> class containing all parameters that can be varied in the model.
Used for setting up scenarios, the <code class="docutils literal notranslate"><span class="pre">scenarios</span></code> class contains baseline parameters which can be changed at runtime.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Scenario</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Holds LoS dists for each patient type</span>
<span class="sd">    Holds delay dists</span>
<span class="sd">    Holds prob of delay, prob of same day dist</span>
<span class="sd">    Holds resources: beds</span>
<span class="sd">    Passed to hospital model and process classes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schedule</span><span class="p">,</span> <span class="n">schedule_avail</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                 <span class="n">random_number_set</span><span class="o">=</span><span class="n">default_rng_set</span><span class="p">,</span>
                 <span class="n">primary_hip_mean_los</span><span class="o">=</span><span class="n">DEFAULT_PRIMARY_HIP_MEAN_LOS</span><span class="p">,</span>
                 <span class="n">primary_knee_mean_los</span><span class="o">=</span><span class="n">DEFAULT_PRIMARY_KNEE_MEAN_LOS</span><span class="p">,</span>
                 <span class="n">revision_hip_mean_los</span><span class="o">=</span><span class="n">DEFAULT_REVISION_HIP_MEAN_LOS</span><span class="p">,</span>
                 <span class="n">revision_knee_mean_los</span><span class="o">=</span><span class="n">DEFAULT_REVISION_KNEE_MEAN_LOS</span><span class="p">,</span>
                 <span class="n">unicompart_knee_mean_los</span><span class="o">=</span><span class="n">DEFAULT_UNICOMPART_KNEE_MEAN_LOS</span><span class="p">,</span>
                 <span class="n">delay_post_los_mean</span><span class="o">=</span><span class="n">DEFAULT_DELAY_POST_LOS_MEAN</span><span class="p">,</span>
                 <span class="n">prob_ward_delay</span><span class="o">=</span><span class="n">DEFAULT_PROB_WARD_DELAY</span><span class="p">,</span>
                 <span class="n">n_beds</span><span class="o">=</span><span class="n">DEFAULT_NUMBER_BEDS</span><span class="p">,</span>
                 <span class="n">primary_hip_sd_los</span><span class="o">=</span><span class="n">DEFAULT_PRIMARY_HIP_SD_LOS</span><span class="p">,</span>
                 <span class="n">primary_knee_sd_los</span><span class="o">=</span><span class="n">DEFAULT_PRIMARY_KNEE_SD_LOS</span><span class="p">,</span>
                 <span class="n">revision_hip_sd_los</span><span class="o">=</span><span class="n">DEFAULT_REVISION_HIP_SD_LOS</span><span class="p">,</span>
                 <span class="n">revision_knee_sd_los</span><span class="o">=</span><span class="n">DEFAULT_REVISION_KNEE_SD_LOS</span><span class="p">,</span>
                 <span class="n">unicompart_knee_sd_los</span><span class="o">=</span><span class="n">DEFAULT_UNICOMPART_KNEE_SD_LOS</span><span class="p">,</span>
                 <span class="n">delay_post_los_sd</span><span class="o">=</span><span class="n">DEFAULT_DELAY_POST_LOS_SD</span><span class="p">,</span>
                 <span class="n">primary_dict</span><span class="o">=</span><span class="n">DEFAULT_PRIMARY_DICT</span><span class="p">,</span>
                 <span class="n">revision_dict</span><span class="o">=</span><span class="n">DEFAULT_REVISION_DICT</span><span class="p">,</span>
                 <span class="n">primary_prob</span><span class="o">=</span><span class="n">DEFAULT_PRIMARY_PROB</span><span class="p">,</span>
                 <span class="n">revision_prob</span><span class="o">=</span><span class="n">DEFAULT_REVISION_PROB</span><span class="p">,</span>
                 <span class="n">primary_knee_los_data</span> <span class="o">=</span> <span class="n">primary_knee_los_data</span><span class="p">,</span>
                 <span class="n">unicompart_knee_los_data</span> <span class="o">=</span> <span class="n">unicomp_knee_los_data</span><span class="p">,</span>
                 <span class="n">revision_knee_los_data</span> <span class="o">=</span> <span class="n">revision_knee_los_data</span><span class="p">,</span>
                 <span class="n">primary_hip_los_data</span> <span class="o">=</span> <span class="n">primary_hip_los_data</span><span class="p">,</span>
                 <span class="n">revision_hip_los_data</span> <span class="o">=</span> <span class="n">revision_hip_los_data</span><span class="p">):</span>
    
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        controls initial seeds of each RNS used in model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span> <span class="o">=</span> <span class="n">schedule</span>
        <span class="k">if</span> <span class="n">schedule_avail</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schedule_avail</span> <span class="o">=</span> <span class="n">schedule</span><span class="o">.</span><span class="n">theatre_capacity</span><span class="p">()</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schedule_avail</span> <span class="o">=</span> <span class="n">schedule_avail</span>
        <span class="c1">#self.schedule_avail = schedule_avail   </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_number_set</span> <span class="o">=</span> <span class="n">random_number_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_hip_mean_los</span> <span class="o">=</span> <span class="n">primary_hip_mean_los</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_knee_mean_los</span> <span class="o">=</span> <span class="n">primary_knee_mean_los</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revision_hip_mean_los</span> <span class="o">=</span> <span class="n">revision_hip_mean_los</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">revision_knee_mean_los</span> <span class="o">=</span> <span class="n">revision_knee_mean_los</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unicompart_knee_mean_los</span> <span class="o">=</span> <span class="n">unicompart_knee_mean_los</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_beds</span> <span class="o">=</span> <span class="n">n_beds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prob_ward_delay</span> <span class="o">=</span> <span class="n">prob_ward_delay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_hip_sd_los</span> <span class="o">=</span> <span class="n">primary_hip_sd_los</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_knee_sd_los</span> <span class="o">=</span> <span class="n">primary_knee_sd_los</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revision_hip_sd_los</span> <span class="o">=</span> <span class="n">revision_hip_sd_los</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revision_knee_sd_los</span> <span class="o">=</span> <span class="n">revision_knee_sd_los</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unicompart_knee_sd_los</span> <span class="o">=</span> <span class="n">unicompart_knee_sd_los</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay_post_los_mean</span> <span class="o">=</span> <span class="n">delay_post_los_mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay_post_los_sd</span> <span class="o">=</span> <span class="n">delay_post_los_sd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_dict</span> <span class="o">=</span> <span class="n">primary_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revision_dict</span> <span class="o">=</span> <span class="n">revision_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_prob</span> <span class="o">=</span> <span class="n">primary_prob</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revision_prob</span> <span class="o">=</span> <span class="n">revision_prob</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_knee_los_data</span> <span class="o">=</span> <span class="n">primary_knee_los_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unicompart_knee_los_data</span> <span class="o">=</span> <span class="n">unicompart_knee_los_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revision_knee_los_data</span> <span class="o">=</span> <span class="n">revision_knee_los_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_hip_los_data</span> <span class="o">=</span> <span class="n">primary_hip_los_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revision_hip_los_data</span> <span class="o">=</span> <span class="n">revision_hip_los_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_sampling</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_random_no_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">random_number_set</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        controls random sampling for each distribution used in simulations&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_number_set</span> <span class="o">=</span> <span class="n">random_number_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_sampling</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">init_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        distribs used in model and initialise seed&quot;&quot;&quot;</span>
        <span class="n">rng_streams</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_number_set</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seeds</span> <span class="o">=</span> <span class="n">rng_streams</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">99999999999</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span>
        
        <span class="c1">#######  Distributions ########</span>
        <span class="c1"># LNorm LoS distribution for each surgery patient type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_hip_dist</span> <span class="o">=</span> <span class="n">Lognormal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_hip_mean_los</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_hip_sd_los</span><span class="p">,</span>
                                          <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_knee_dist</span> <span class="o">=</span> <span class="n">Lognormal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_knee_mean_los</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_knee_sd_los</span><span class="p">,</span>
                                          <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revision_hip_dist</span> <span class="o">=</span> <span class="n">Lognormal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">revision_hip_mean_los</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">revision_hip_sd_los</span><span class="p">,</span>
                                          <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revision_knee_dist</span> <span class="o">=</span> <span class="n">Lognormal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">revision_knee_mean_los</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">revision_knee_sd_los</span><span class="p">,</span>
                                          <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unicompart_knee_dist</span> <span class="o">=</span> <span class="n">Lognormal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unicompart_knee_mean_los</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unicompart_knee_sd_los</span><span class="p">,</span>
                                          <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        
        <span class="c1"># Empirical LoS distributions for each surgery patient type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_hip_dist_emp</span> <span class="o">=</span> <span class="n">Empirical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_hip_los_data</span><span class="p">,</span>
                                            <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_knee_dist_emp</span> <span class="o">=</span> <span class="n">Empirical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_knee_los_data</span><span class="p">,</span>
                                            <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revision_hip_dist_emp</span> <span class="o">=</span> <span class="n">Empirical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">revision_hip_los_data</span><span class="p">,</span>
                                            <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revision_knee_dist_emp</span> <span class="o">=</span> <span class="n">Empirical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">revision_knee_los_data</span><span class="p">,</span>
                                            <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unicompart_knee_dist_emp</span> <span class="o">=</span> <span class="n">Empirical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unicompart_knee_los_data</span><span class="p">,</span>
                                            <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
        
        <span class="c1"># distribution for delayed LoS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">los_delay_dist</span> <span class="o">=</span> <span class="n">Lognormal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delay_post_los_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay_post_los_sd</span><span class="p">,</span>
                                       <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
        
        <span class="c1">#probability of having LoS delayed on ward</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">los_delay</span> <span class="o">=</span> <span class="n">Bernoulli</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prob_ward_delay</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span>
        
    <span class="k">def</span> <span class="nf">number_slots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schedule_avail</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        convert to np arrays for each surgery type for patient generators</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule_avail_primary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule_avail</span><span class="p">[</span><span class="s1">&#39;Primary_slots&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule_avail_revision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule_avail</span><span class="p">[</span><span class="s1">&#39;Revision_slots&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schedule_avail_primary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule_avail_revision</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">primary_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">prob</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        randomly select primary surgical type from custom distribution: primary_prop</span>
<span class="sd">        prob = primary_prop</span>
<span class="sd">        used for generating primary patients of each surgical type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_surgery</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">p</span><span class="o">=</span><span class="n">prob</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_surgery</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">revision_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">prob</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        randomly select revision surgical type from custom distribution: revision_prop</span>
<span class="sd">        prob = revision_prop</span>
<span class="sd">        used for generating revision patients of each surgical type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revision_surgery</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">p</span><span class="o">=</span><span class="n">prob</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">revision_surgery</span><span class="p">)</span>
     
    <span class="k">def</span> <span class="nf">label_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> 
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return label for each surgery type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">)(</span><span class="n">prop</span><span class="p">)</span>
    
</pre></div>
</div>
</div>
</div>
</section>
<section id="patient-pathways-process-logic">
<h2>6. Patient pathways process logic<a class="headerlink" href="#patient-pathways-process-logic" title="Permalink to this headline">#</a></h2>
<p>Patient journeys for two classes: <code class="docutils literal notranslate"><span class="pre">PrimaryPatient</span></code> and <code class="docutils literal notranslate"><span class="pre">RevisionPatient</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PrimaryPatient</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The process a patient needing primary hip or knee surgery will undergo</span>
<span class="sd">    from scheduled admission for surgery to discharge</span>
<span class="sd">    </span>
<span class="sd">    day = simulation day</span>
<span class="sd">    id = patient id</span>
<span class="sd">    args: Scenario parameter class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">day</span> <span class="o">=</span> <span class="n">day</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_beds</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_los</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depart</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">lost_slots_bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delayed_los_bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weekday</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patient_class</span> <span class="o">=</span> <span class="s1">&#39;primary&#39;</span>
        
    <span class="k">def</span> <span class="nf">service</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Arrive according to theatres schedule</span>
<span class="sd">        Some patients will leave on day of surgery and the slot is lost</span>
<span class="sd">        Some patients will have their surgery cancelled due to lack of beds</span>
<span class="sd">        Otherwise, patient is admitted and stays in a bed</span>
<span class="sd">        Some patients will have a post-bed request delay to their LoS</span>
<span class="sd">        Patient is discharged</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patient_class</span> <span class="o">=</span> <span class="s1">&#39;primary&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weekday</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>
        
        <span class="c1"># set los for primary surgery types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">primary_types</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">primary_prob</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">types</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_empirical_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">primary_los</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">primary_hip_dist_emp</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">primary_los</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">primary_hip_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">primary_label</span> <span class="o">=</span> <span class="s1">&#39;p_hip&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">types</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_empirical_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">primary_los</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">primary_knee_dist_emp</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">primary_los</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">primary_knee_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">primary_label</span> <span class="o">=</span> <span class="s1">&#39;p_knee&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_empirical_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">primary_los</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">unicompart_knee_dist_emp</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">primary_los</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">unicompart_knee_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">primary_label</span> <span class="o">=</span> <span class="s1">&#39;uni_knee&#39;</span>

        <span class="c1">#vectorize according to dict key to get surgical type</span>
        <span class="c1">#self.primary_label = self.args.label_types(primary_prop, primary_dict)   </span>
            
        <span class="c1">#sample if need for delayed discharge</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">need_for_los_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">los_delay</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
        
        <span class="c1">#Patients who have a delayed discharge follow this pathway</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">need_for_los_delay</span><span class="p">:</span>
            
            <span class="c1">#request a bed on ward - if none available within 0.5-1 day, patient has surgery cancelled</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">beds</span><span class="o">.</span><span class="n">request</span><span class="p">()</span> <span class="k">as</span> <span class="n">req</span><span class="p">:</span>
                
                <span class="n">admission</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">admit</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">req</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">admission</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">admit</span><span class="p">:</span>
                    <span class="sd">&quot;&quot;&quot;record queue time for primary patients -- if &gt; admission, </span>
<span class="sd">                    this patient will leave the system and the slot is lost&quot;&quot;&quot;</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">queue_beds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span>
                    <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;primary patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_label</span><span class="si">}</span><span class="s1">&#39;</span> 
                          <span class="sa">f</span><span class="s1">&#39;has been allocated a bed at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span> 
                          <span class="sa">f</span><span class="s1">&#39;and queued for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">queue_beds</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">primary_los</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">los_delay_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_los</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lost_slots_bool</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delayed_los_bool</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">depart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>
                    <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;los of primary patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> completed at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span>
                    <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;primary patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_label</span><span class="si">}</span><span class="s1">&#39;</span>
                          <span class="sa">f</span><span class="s1">&#39;total los = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">total_time</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> with delayed discharge&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#patient had to leave as no beds were available on ward</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">no_bed_cancellation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span>
                    <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;primary patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_label</span><span class="si">}</span><span class="s1">&#39;</span>
                          <span class="sa">f</span><span class="s1">&#39;had surgery cancelled after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">no_bed_cancellation</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">queue_beds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">primary_los</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lost_slots_bool</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delayed_los_bool</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">depart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>
                    <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;primary patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_label</span><span class="si">}</span><span class="s1">&#39;</span> 
                          <span class="sa">f</span><span class="s1">&#39;recorded </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lost_slots_bool</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1">#no delayed los</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#request a bed on ward - if none available within 0.5-1 day, patient has surgery cancelled</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">beds</span><span class="o">.</span><span class="n">request</span><span class="p">()</span> <span class="k">as</span> <span class="n">req</span><span class="p">:</span>
                <span class="n">admission</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">admit</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">req</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">admission</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">no_bed_cancellation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span>

                <span class="k">if</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">admit</span><span class="p">:</span>
                    <span class="c1">#record queue time for primary patients -- if &gt;1, this patient will leave the system and the slot is lost</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">queue_beds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span>
                    <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;primary patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_label</span><span class="si">}</span><span class="s1">&#39;</span>
                          <span class="sa">f</span><span class="s1">&#39;has been allocated a bed at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span>
                          <span class="sa">f</span><span class="s1">&#39;and queued for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">queue_beds</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">primary_los</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_los</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_los</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lost_slots_bool</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delayed_los_bool</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">depart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>
                    <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;los of primary patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_label</span><span class="si">}</span><span class="s1">&#39;</span>
                          <span class="sa">f</span><span class="s1">&#39;completed at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span>
                    <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;primary patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_label</span><span class="si">}</span><span class="s1">&#39;</span>
                          <span class="sa">f</span><span class="s1">&#39;total los = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">total_time</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#patient had to leave as no beds were available on ward</span>
                    <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;primary patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_label</span><span class="si">}</span><span class="s1">&#39;</span>
                          <span class="sa">f</span><span class="s1">&#39;had surgery cancelled after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">no_bed_cancellation</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">queue_beds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">primary_los</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lost_slots_bool</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delayed_los_bool</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">depart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>
                    <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;primary patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_label</span><span class="si">}</span><span class="s1">&#39;</span> 
                          <span class="sa">f</span><span class="s1">&#39;recorded </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lost_slots_bool</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
<span class="k">class</span> <span class="nc">RevisionPatient</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The process a patient needing revision hip or knee surgery will undergo</span>
<span class="sd">    from scheduled admission for surgery to discharge</span>
<span class="sd">    </span>
<span class="sd">    day = simulation day</span>
<span class="sd">    id = patient id</span>
<span class="sd">    args: Scenario parameter class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">day</span> <span class="o">=</span> <span class="n">day</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_beds</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revision_los</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depart</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">lost_slots_bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delayed_los_bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weekday</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patient_class</span> <span class="o">=</span> <span class="s1">&#39;revision&#39;</span>
        
    <span class="k">def</span> <span class="nf">service</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Arrive according to theatres schedule</span>
<span class="sd">        Some patients will leave on day of surgery and the slot is lost</span>
<span class="sd">        Some patients will have their surgery cancelled due to lack of beds</span>
<span class="sd">        Otherwise, patient is admitted and stays in a bed</span>
<span class="sd">        Some patients will have a post-bed request delay to their LoS</span>
<span class="sd">        Patient is discharged</span>
<span class="sd">        &quot;&quot;&quot;</span>
     
        <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patient_class</span> <span class="o">=</span> <span class="s1">&#39;revision&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weekday</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>
        
        <span class="c1"># set los for revision surgery types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">revision_types</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">revision_prob</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">types</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_empirical_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">revision_los</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">revision_hip_dist_emp</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">revision_los</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">revision_hip_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">revision_label</span> <span class="o">=</span> <span class="s1">&#39;r_hip&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_empirical_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">revision_los</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">revision_knee_dist_emp</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">revision_los</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">revision_knee_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">revision_label</span> <span class="o">=</span> <span class="s1">&#39;r_knee&#39;</span>
            
        <span class="c1">#vectorize according to dict key to get surgical type</span>
        <span class="c1">#self.revision_label = self.args.label_types(revision_prop, revision_dict) </span>
        
        <span class="c1">#sample if need for delayed discharge</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">need_for_los_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">los_delay</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">need_for_los_delay</span><span class="p">:</span>    
        
        <span class="c1">#request bed on ward - if none available within 0.5-1  day, patient has surgery cancelled</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">beds</span><span class="o">.</span><span class="n">request</span><span class="p">()</span> <span class="k">as</span> <span class="n">req</span><span class="p">:</span>
                <span class="n">admission</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">admit</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">req</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">admission</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">admit</span><span class="p">:</span>
                    <span class="c1">#record queue time for primary patients -- if &gt;admission, this patient will leave the system and the slot is lost</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">queue_beds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span>
                    <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;revision patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">revision_label</span><span class="si">}</span><span class="s1">&#39;</span>
                          <span class="sa">f</span><span class="s1">&#39;has been allocated a bed at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span>
                          <span class="sa">f</span><span class="s1">&#39;and queued for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">queue_beds</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                
                    <span class="bp">self</span><span class="o">.</span><span class="n">revision_los</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">los_delay_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">revision_los</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lost_slots_bool</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delayed_los_bool</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">depart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>
                    <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;los of revision patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">revision_label</span><span class="si">}</span><span class="s1">&#39;</span>
                          <span class="sa">f</span><span class="s1">&#39;completed at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span>
                    <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;revision patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">revision_label</span><span class="si">}</span><span class="s1">&#39;</span>
                          <span class="sa">f</span><span class="s1">&#39;total los = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">total_time</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> with delayed discharge&#39;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#patient had to leave as no beds were available on ward</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">no_bed_cancellation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span>
                    <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;revision patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span>
                          <span class="sa">f</span><span class="s1">&#39;had surgery cancelled after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">no_bed_cancellation</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">queue_beds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">revision_los</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lost_slots_bool</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delayed_los_bool</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">depart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>
                    <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;revision patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">revision_label</span><span class="si">}</span><span class="s1">&#39;</span>
                          <span class="sa">f</span><span class="s1">&#39;recorded </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lost_slots_bool</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1">#no need for delayed discharge            </span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#request bed on ward - if none available within 0.5-1  day, patient has surgery cancelled</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">beds</span><span class="o">.</span><span class="n">request</span><span class="p">()</span> <span class="k">as</span> <span class="n">req</span><span class="p">:</span>
                <span class="n">admission</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">admit</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">req</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">admission</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">no_bed_cancellation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span>

                <span class="k">if</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">admit</span><span class="p">:</span>
                    <span class="c1">#record queue time for primary patients -- if &gt;1, this patient will leave the system and the slot is lost</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">queue_beds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span>
                    <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;revision patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">revision_label</span><span class="si">}</span><span class="s1">&#39;</span>
                          <span class="sa">f</span><span class="s1">&#39;has been allocated a bed at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span>
                          <span class="sa">f</span><span class="s1">&#39;and queued for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">queue_beds</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">revision_los</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">revision_los</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">revision_los</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lost_slots_bool</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delayed_los_bool</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">depart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>

                    <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;los of revision patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> completed at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span>
                    <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;revision patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> total los = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">total_time</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#patient had to leave as no beds were available on ward</span>
                    <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;revision patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">revision_label</span><span class="si">}</span><span class="s1">&#39;</span>
                          <span class="sa">f</span><span class="s1">&#39;had surgery cancelled after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">no_bed_cancellation</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">queue_beds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">revision_los</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lost_slots_bool</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delayed_los_bool</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">depart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> 
                    <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;revision patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">revision_label</span><span class="si">}</span><span class="s1">&#39;</span> 
                          <span class="sa">f</span><span class="s1">&#39;recorded </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lost_slots_bool</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    
</pre></div>
</div>
</div>
</div>
</section>
<section id="the-model-class">
<h2>7. The model class<a class="headerlink" href="#the-model-class" title="Permalink to this headline">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">Hospital</span></code> class generates primary and revision patients and implements a method to run the model.</p>
<p>Collects patient-level results and audits daily results</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Hospital</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The orthopaedic hospital model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Environment</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_resources</span><span class="p">()</span>
        
        <span class="c1">#patient generator lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patients</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_patients</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revision_patients</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_patients_id</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revision_patients_id</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cum_primary_patients</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cum_revision_patients</span> <span class="o">=</span> <span class="p">[]</span>
               
        <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_RESULTS_COLLECTION_PERIOD</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summary_results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_interval</span> <span class="o">=</span> <span class="n">interval</span>
        
        <span class="c1">#lists used for daily audit_frame for summary results per day</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_time</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_day_of_week</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_beds_used_primary</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_beds_used_revision</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_beds_used</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_primary_arrival</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_revision_arrival</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_primary_queue_beds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_revision_queue_beds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_primary_los</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_revision_los</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
       
    <span class="k">def</span> <span class="nf">audit_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dataframe with results summarised per day </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;sim_time&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">audit_time</span><span class="p">,</span>
                                     <span class="s1">&#39;weekday&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_day_of_week</span><span class="p">,</span>
                                     <span class="s1">&#39;bed_utilisation_primary&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_beds_used_primary</span><span class="p">,</span>
                                     <span class="s1">&#39;bed_utilisation_revision&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_beds_used_revision</span><span class="p">,</span>
                                     <span class="s1">&#39;bed_utilisation&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">audit_beds_used</span><span class="p">,</span>
                                     <span class="s1">&#39;primary_arrivals&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_primary_arrival</span><span class="p">,</span>
                                     <span class="s1">&#39;revision_arrivals&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_revision_arrival</span><span class="p">,</span>
                                     <span class="s1">&#39;primary_bed_queue&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_primary_queue_beds</span><span class="p">,</span>
                                     <span class="s1">&#39;revision_bed_queue&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_revision_queue_beds</span><span class="p">,</span>
                                     <span class="s1">&#39;primary_mean_los&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_primary_los</span><span class="p">,</span>
                                     <span class="s1">&#39;revision_mean_los&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_revision_los</span>
                                    <span class="p">})</span>

    <span class="k">def</span> <span class="nf">patient_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dataframes to hold individual results per patient per day per run</span>
<span class="sd">        Attributes from patient classes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">results_primary_pt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Day&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_primary_patients</span><span class="p">]),</span>
                             <span class="s1">&#39;weekday&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;weekday&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_primary_patients</span><span class="p">]),</span>
                             <span class="s1">&#39;ID&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_primary_patients</span><span class="p">]),</span>
                             <span class="s1">&#39;arrival time&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;arrival&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_primary_patients</span><span class="p">]),</span>
                             <span class="s1">&#39;patient class&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;patient_class&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_primary_patients</span><span class="p">]),</span>
                             <span class="s1">&#39;surgery type&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;primary_label&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_primary_patients</span><span class="p">]),</span>
                             <span class="s1">&#39;lost slots&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;lost_slots_bool&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_primary_patients</span><span class="p">]),</span>
                             <span class="s1">&#39;queue time&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;queue_beds&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_primary_patients</span><span class="p">]),</span>
                             <span class="s1">&#39;los&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;primary_los&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_primary_patients</span><span class="p">]),</span>
                             <span class="s1">&#39;delayed discharge&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;delayed_los_bool&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_primary_patients</span><span class="p">]),</span>
                             <span class="s1">&#39;depart&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;depart&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_primary_patients</span><span class="p">])</span>
                            <span class="p">})</span>
    
        <span class="n">results_revision_pt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Day&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_revision_patients</span><span class="p">]),</span>
                             <span class="s1">&#39;ID&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_revision_patients</span><span class="p">]),</span>
                             <span class="s1">&#39;weekday&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;weekday&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_revision_patients</span><span class="p">]),</span>
                             <span class="s1">&#39;arrival time&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;arrival&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_revision_patients</span><span class="p">]),</span>
                             <span class="s1">&#39;patient class&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;patient_class&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_revision_patients</span><span class="p">]),</span>
                             <span class="s1">&#39;surgery type&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;revision_label&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_revision_patients</span><span class="p">]),</span>
                             <span class="s1">&#39;lost slots&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;lost_slots_bool&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_revision_patients</span><span class="p">]),</span>
                             <span class="s1">&#39;queue time&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;queue_beds&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_revision_patients</span><span class="p">]),</span>
                             <span class="s1">&#39;los&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;revision_los&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_revision_patients</span><span class="p">]),</span>
                             <span class="s1">&#39;delayed discharge&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;delayed_los_bool&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_revision_patients</span><span class="p">]),</span>
                             <span class="s1">&#39;depart&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;depart&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_revision_patients</span><span class="p">])</span>
                            <span class="p">})</span>
        <span class="k">return</span><span class="p">(</span><span class="n">results_primary_pt</span><span class="p">,</span> <span class="n">results_revision_pt</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">plots</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        plot results at end of run</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">perform_audit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Results per day</span>
<span class="sd">        monitor ED each day and return daily results for metrics in audit_frame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">DEFAULT_WARM_UP_PERIOD</span><span class="p">)</span>
        
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1">#simulation time</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">audit_time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            
            <span class="c1">#weekday</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">audit_day_of_week</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">weekday</span><span class="p">())</span>
             
            <span class="c1">##########  bed utilisation - primary, revision, total</span>
            <span class="n">primary_beds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">beds</span><span class="o">.</span><span class="n">count</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_primary_patients</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">audit_beds_used_primary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">primary_beds</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">n_beds</span><span class="p">))</span>

            <span class="n">revision_beds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">beds</span><span class="o">.</span><span class="n">count</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_revision_patients</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">audit_beds_used_revision</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">revision_beds</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">n_beds</span><span class="p">))</span>
                                         
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">audit_beds_used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">beds</span><span class="o">.</span><span class="n">count</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">n_beds</span><span class="p">))</span>
            
            <span class="c1">###########  lost slots</span>
            <span class="n">patients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_revision_patients</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_primary_patients</span>
            
            <span class="c1"># deal with lost slots on zero arrival days</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            lost_slots = []</span>
<span class="sd">            def zero_days(ls):</span>
<span class="sd">                if not zero_days:</span>
<span class="sd">                    return 1</span>
<span class="sd">                else:</span>
<span class="sd">                    return 0</span>
<span class="sd"> </span>
<span class="sd">            ls = (np.array([getattr(p, &#39;lost_slots_int&#39;) for p in patients]))</span>
<span class="sd">            if zero_days(ls):</span>
<span class="sd">                lost_slots = 0</span>
<span class="sd">            else:</span>
<span class="sd">            </span>
<span class="sd">            lost_slots = len(np.array([getattr(p,&#39;lost_slots_int&#39;) for p in patients / len(patients)</span>
<span class="sd">            self.audit_slots_lost.append(lost_slots)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1">######### arrivals</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_primary_patients</span><span class="p">]))</span>
            <span class="n">rp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_revision_patients</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">audit_primary_arrival</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_patients</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">audit_revision_arrival</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">revision_patients</span><span class="p">))</span>
                                               
            <span class="c1">#queue times</span>
            <span class="n">primary_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;queue_beds&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_primary_patients</span>
                                           <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;queue_beds&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">audit_primary_queue_beds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">primary_q</span><span class="p">)</span>
                                               
            <span class="n">revision_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;queue_beds&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_revision_patients</span>
                                           <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;queue_beds&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">audit_revision_queue_beds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">revision_q</span><span class="p">)</span>
                                               
            <span class="c1">#mean lengths of stay</span>
            <span class="n">primarylos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;primary_los&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_primary_patients</span>
                                           <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;primary_los&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">audit_primary_los</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">primarylos</span><span class="p">)</span>
                                               
            <span class="n">revisionlos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;revision_los&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_revision_patients</span>
                                           <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;revision_los&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">audit_revision_los</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">revisionlos</span><span class="p">)</span>
            
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">audit_interval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ward beds initialised and stored in args</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">beds</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> 
                                        <span class="n">capacity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">n_beds</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results_collection</span> <span class="o">=</span> <span class="n">DEFAULT_RESULTS_COLLECTION_PERIOD</span><span class="o">+</span><span class="n">DEFAULT_WARM_UP_PERIOD</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        single run of model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_arrivals_generator_primary</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_arrivals_generator_revision</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">perform_audit</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results_collection</span> <span class="o">=</span> <span class="n">results_collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">until</span><span class="o">=</span><span class="n">results_collection</span><span class="p">)</span>
        <span class="n">audit_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_frame</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">audit_frame</span>
    
    <span class="k">def</span> <span class="nf">patient_arrivals_generator_primary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Primary patients arrive according to daily theatre schedule</span>
<span class="sd">        ------------------</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#sched = args.number_slots(self.args.schedule_avail)[0]</span>
        <span class="n">sched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">schedule_avail</span><span class="p">[</span><span class="s1">&#39;Primary_slots&#39;</span><span class="p">]</span>
        <span class="n">pt_count</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sched</span><span class="p">)):</span>
            
            <span class="n">primary_arrivals</span> <span class="o">=</span> <span class="n">sched</span><span class="p">[</span><span class="n">day</span><span class="p">]</span>
            <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;--------- </span><span class="si">{</span><span class="n">primary_arrivals</span><span class="si">}</span><span class="s1"> primary patients are scheduled on Day </span><span class="si">{</span><span class="n">day</span><span class="si">}</span><span class="s1"> -------&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">primary_arrivals</span><span class="p">):</span>
                
                    <span class="n">new_primary_patient</span> <span class="o">=</span> <span class="n">PrimaryPatient</span><span class="p">(</span><span class="n">day</span><span class="p">,</span> <span class="n">pt_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cum_primary_patients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_primary_patient</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">primary_patients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_primary_patient</span><span class="p">)</span>
                    <span class="c1">#for debuggng</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">primary_patients_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_primary_patient</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;primary patient </span><span class="si">{</span><span class="n">pt_count</span><span class="si">}</span><span class="s1"> arrived on day </span><span class="si">{</span><span class="n">day</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">new_primary_patient</span><span class="o">.</span><span class="n">service</span><span class="p">())</span>
                    <span class="n">pt_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;primary ids: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_patients_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">primary_patients</span> <span class="o">*=</span> <span class="mi">0</span>
                    
            
    <span class="k">def</span> <span class="nf">patient_arrivals_generator_revision</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Revision patients arrive according to daily theatre schedule</span>
<span class="sd">        ------------------</span>
<span class="sd">        &quot;&quot;&quot;</span>    
        <span class="n">sched</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">number_slots</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">schedule_avail</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">schedule_avail</span><span class="p">[</span><span class="s1">&#39;Revision_slots&#39;</span><span class="p">]</span>
        <span class="n">pt_count</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sched</span><span class="p">)):</span>
            
            <span class="n">revision_arrivals</span> <span class="o">=</span> <span class="n">sched</span><span class="p">[</span><span class="n">day</span><span class="p">]</span>
            <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;--------- </span><span class="si">{</span><span class="n">revision_arrivals</span><span class="si">}</span><span class="s1"> revision patients are scheduled on Day </span><span class="si">{</span><span class="n">day</span><span class="si">}</span><span class="s1"> -------&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">revision_arrivals</span><span class="p">):</span>
                    <span class="n">new_revision_patient</span> <span class="o">=</span> <span class="n">RevisionPatient</span><span class="p">(</span><span class="n">day</span><span class="p">,</span> <span class="n">pt_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cum_revision_patients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_revision_patient</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">revision_patients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_revision_patient</span><span class="p">)</span>
                    <span class="c1">#for debugging</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">revision_patients_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_revision_patient</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;revision patient </span><span class="si">{</span><span class="n">pt_count</span><span class="si">}</span><span class="s1"> arrived on day </span><span class="si">{</span><span class="n">day</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">new_revision_patient</span><span class="o">.</span><span class="n">service</span><span class="p">())</span>
                    <span class="n">pt_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;revision ids: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">revision_patients_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">revision_patients</span> <span class="o">*=</span> <span class="mi">0</span>
                    
                    
</pre></div>
</div>
</div>
</div>
</section>
<section id="summary-results-across-days-and-runs">
<h2>8. Summary results across days and runs<a class="headerlink" href="#summary-results-across-days-and-runs" title="Permalink to this headline">#</a></h2>
<p>Overall summary of results across all runs, and across model run time.</p>
<p>Used for validation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Summary</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    summary results across run</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; model: Hospital &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summary_results</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="k">def</span> <span class="nf">process_run_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summary_results</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1">#all patients arrived during results collection period</span>
        <span class="n">patients</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">cum_primary_patients</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">day</span> <span class="o">&gt;</span> <span class="n">DEFAULT_WARM_UP_PERIOD</span><span class="p">])</span><span class="o">+</span>\
            <span class="nb">len</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">cum_revision_patients</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">day</span> <span class="o">&gt;</span> <span class="n">DEFAULT_WARM_UP_PERIOD</span><span class="p">])</span>
        
        <span class="n">primary_arrivals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">cum_primary_patients</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">day</span> <span class="o">&gt;</span> <span class="n">DEFAULT_WARM_UP_PERIOD</span><span class="p">])</span>
        <span class="n">revision_arrivals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">cum_revision_patients</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">day</span> <span class="o">&gt;</span> <span class="n">DEFAULT_WARM_UP_PERIOD</span><span class="p">])</span>

        <span class="c1">#throughput during results collection period</span>
        <span class="n">primary_throughput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">cum_primary_patients</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">total_time</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
                                  <span class="o">&amp;</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">day</span> <span class="o">&gt;</span> <span class="n">DEFAULT_WARM_UP_PERIOD</span><span class="p">)])</span>
        <span class="n">revision_throughput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">cum_revision_patients</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">total_time</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
                                   <span class="o">&amp;</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">day</span> <span class="o">&gt;</span> <span class="n">DEFAULT_WARM_UP_PERIOD</span><span class="p">)])</span>

        <span class="c1">#mean queues - this also includes patients who renege and therefore have 0 queue</span>
        <span class="n">mean_primary_queue_beds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;queue_beds&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">cum_primary_patients</span>
                                            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;queue_beds&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">mean_revision_queue_beds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;queue_beds&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">cum_revision_patients</span>
                                            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;queue_beds&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1">#check mean los</span>
        <span class="n">mean_primary_los</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;primary_los&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">cum_primary_patients</span>
                                               <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;primary_los&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">mean_revision_los</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;revision_los&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">cum_revision_patients</span>
                                               <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;revision_los&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1">#bed utilisation primary and revision patients during results collection period</span>
        <span class="n">los_primary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s1">&#39;primary_los&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">cum_primary_patients</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;primary_los&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">DEFAULT_WARM_UP_PERIOD</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">mean_primary_bed_utilisation</span> <span class="o">=</span> <span class="n">los_primary</span> <span class="o">/</span> <span class="p">(</span><span class="n">DEFAULT_RESULTS_COLLECTION_PERIOD</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">n_beds</span><span class="p">)</span>
        <span class="n">los_revision</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s1">&#39;revision_los&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">cum_revision_patients</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;revision_los&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">DEFAULT_WARM_UP_PERIOD</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">mean_revision_bed_utilisation</span> <span class="o">=</span> <span class="n">los_revision</span> <span class="o">/</span> <span class="p">(</span><span class="n">DEFAULT_RESULTS_COLLECTION_PERIOD</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">n_beds</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">summary_results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;arrivals&#39;</span><span class="p">:</span><span class="n">patients</span><span class="p">,</span>
                                <span class="s1">&#39;primary_arrivals&#39;</span><span class="p">:</span><span class="n">primary_arrivals</span><span class="p">,</span>  
                                <span class="s1">&#39;revision_arrivals&#39;</span><span class="p">:</span><span class="n">revision_arrivals</span><span class="p">,</span>                     
                                <span class="s1">&#39;primary_throughput&#39;</span><span class="p">:</span><span class="n">primary_throughput</span><span class="p">,</span>
                                <span class="s1">&#39;revision_throughput&#39;</span><span class="p">:</span><span class="n">revision_throughput</span><span class="p">,</span>
                                <span class="s1">&#39;primary_queue&#39;</span><span class="p">:</span><span class="n">mean_primary_queue_beds</span><span class="p">,</span>
                                <span class="s1">&#39;revision_queue&#39;</span><span class="p">:</span><span class="n">mean_revision_queue_beds</span><span class="p">,</span>
                                <span class="s1">&#39;mean_primary_los&#39;</span><span class="p">:</span><span class="n">mean_primary_los</span><span class="p">,</span>
                                <span class="s1">&#39;mean_revision_los&#39;</span><span class="p">:</span><span class="n">mean_revision_los</span><span class="p">,</span>
                                <span class="s1">&#39;primary_bed_utilisation&#39;</span><span class="p">:</span><span class="n">mean_primary_bed_utilisation</span><span class="p">,</span>
                                <span class="s1">&#39;revision_bed_utilisation&#39;</span><span class="p">:</span><span class="n">mean_revision_bed_utilisation</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">summary_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_run_results</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;1&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">summary_results</span><span class="p">})</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">T</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;rep&#39;</span>
        <span class="k">return</span> <span class="n">df</span>
                                            
</pre></div>
</div>
</div>
</div>
</section>
<section id="model-execution">
<h2>9. Model execution<a class="headerlink" href="#model-execution" title="Permalink to this headline">#</a></h2>
<p>A <code class="docutils literal notranslate"><span class="pre">single_run</span></code> returns three data sets: summary, daily, patient-level</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">multiple_reps</span></code> calls <code class="docutils literal notranslate"><span class="pre">single_run</span></code> for the number of replications.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">single_run</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">results_collection</span><span class="o">=</span><span class="n">DEFAULT_RESULTS_COLLECTION_PERIOD</span><span class="o">+</span><span class="n">DEFAULT_WARM_UP_PERIOD</span><span class="p">,</span> <span class="n">random_no_set</span><span class="o">=</span><span class="n">default_rng_set</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    summary results for a single run which can be called for multiple runs</span>
<span class="sd">    1. summary of single run</span>
<span class="sd">    2. daily audit of mean results per day</span>
<span class="sd">    3a. primary patient results for one run and all days</span>
<span class="sd">    3b. revision patient results for one run and all days</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scenario</span><span class="o">.</span><span class="n">set_random_no_set</span><span class="p">(</span><span class="n">random_no_set</span><span class="p">)</span>
    <span class="n">schedule</span> <span class="o">=</span> <span class="n">Schedule</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Hospital</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">results_collection</span> <span class="o">=</span> <span class="n">results_collection</span><span class="p">)</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">Summary</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    
    <span class="c1">#summary results for a single run </span>
    <span class="c1">#(warmup excluded apart from bed utilisation AND throughput)</span>
    <span class="n">summary_df</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">summary_frame</span><span class="p">()</span>
    
    <span class="c1">#summary per day results for a single run (warmup excluded)</span>
    <span class="n">results_per_day</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">results</span>
    
    <span class="c1">#patient-level results (includes warmup results)</span>
    <span class="n">patient_results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">patient_results</span><span class="p">()</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">summary_df</span><span class="p">,</span> <span class="n">results_per_day</span><span class="p">,</span> <span class="n">patient_results</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">multiple_reps</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">results_collection</span><span class="o">=</span><span class="n">DEFAULT_RESULTS_COLLECTION_PERIOD</span><span class="o">+</span><span class="n">DEFAULT_WARM_UP_PERIOD</span><span class="p">,</span> 
                  <span class="n">n_reps</span><span class="o">=</span><span class="n">DEFAULT_NUMBER_OF_RUNS</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    create dataframes of summary results across multiple runs:</span>
<span class="sd">    1. summary table per run</span>
<span class="sd">    2. summary table per run and per day</span>
<span class="sd">    3a. primary patient results for all days and all runs </span>
<span class="sd">    3b. revision patient results for all days and all runs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#summary per run for multiple reps </span>
    <span class="c1">#(warm-up excluded apart from bed utilisation AND throughput)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">single_run</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">results_collection</span><span class="p">,</span> <span class="n">random_no_set</span><span class="o">=</span><span class="n">rep</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                         <span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_reps</span><span class="p">)]</span>
    <span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="n">df_results</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_results</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df_results</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;rep&#39;</span>
    
    <span class="c1">#summary per day per run for multiple reps (warmup excluded)</span>
    <span class="n">day_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">single_run</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">results_collection</span><span class="p">,</span> <span class="n">random_no_set</span><span class="o">=</span><span class="n">rep</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                         <span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_reps</span><span class="p">)]</span>
    
    <span class="n">length_run</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">results_collection</span><span class="o">-</span><span class="n">DEFAULT_WARM_UP_PERIOD</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">length_reps</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_reps</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">run</span> <span class="o">=</span> <span class="p">[</span><span class="n">rep</span> <span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="n">length_reps</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">length_run</span><span class="p">]</span>
    
    <span class="n">df_day_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">day_results</span><span class="p">)</span>
    <span class="n">df_day_results</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run</span>
    
    <span class="c1">#patient results for all days and all runs (warmup included)</span>
    <span class="n">primary_pt_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">single_run</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">results_collection</span><span class="p">,</span> <span class="n">random_no_set</span><span class="o">=</span><span class="n">rep</span><span class="p">)[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                         <span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_reps</span><span class="p">)]</span>       
    <span class="n">primary_pt_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">primary_pt_results</span><span class="p">)</span>

    <span class="n">revision_pt_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">single_run</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">results_collection</span><span class="p">,</span> <span class="n">random_no_set</span><span class="o">=</span><span class="n">rep</span><span class="p">)[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                         <span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_reps</span><span class="p">)]</span>
    <span class="n">revision_pt_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">revision_pt_results</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">df_results</span><span class="p">,</span> <span class="n">df_day_results</span><span class="p">,</span> <span class="n">primary_pt_results</span><span class="p">,</span> <span class="n">revision_pt_results</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="a-single-run">
<h3>9.1 A single run<a class="headerlink" href="#a-single-run" title="Permalink to this headline">#</a></h3>
<p>Run the model once and check summary results</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># a single run</span>
<span class="n">schedule</span> <span class="o">=</span> <span class="n">Schedule</span><span class="p">()</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">Scenario</span><span class="p">(</span><span class="n">schedule</span><span class="p">)</span>
 
<span class="n">s_results</span> <span class="o">=</span> <span class="n">single_run</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">random_no_set</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">s_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>rep                                1
arrivals                  454.000000
mean_primary_los            4.996316
mean_revision_los           6.143514
primary_arrivals          328.000000
primary_bed_utilisation     0.767368
primary_queue               0.316710
primary_throughput        304.000000
revision_arrivals         126.000000
revision_bed_utilisation    0.166362
revision_queue              0.537871
revision_throughput       122.000000
</pre></div>
</div>
</div>
</div>
</section>
<section id="multiple-independent-replications">
<h3>9.2 Multiple independent replications<a class="headerlink" href="#multiple-independent-replications" title="Permalink to this headline">#</a></h3>
<p>Multiple runs of model and unpack results into summary, daily, and patient level (for primary and revision)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">args</span> <span class="o">=</span> <span class="n">Scenario</span><span class="p">(</span><span class="n">schedule</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">multiple_reps</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">n_reps</span><span class="o">=</span><span class="n">DEFAULT_NUMBER_OF_RUNS</span><span class="p">)</span>
<span class="n">m_results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">m_day_results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">m_primary_pt_results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">r_revision_pt_results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-summary-results-for-multiple-runs">
<h3>9.3 Plot summary results for multiple runs<a class="headerlink" href="#plot-summary-results-for-multiple-runs" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">summary_over_runs</span><span class="p">(</span><span class="n">m_results</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    summary results for multiple runs</span>
<span class="sd">    throughput and bed utilisation excludes results warm-up - arrivals include warmup</span>
<span class="sd">    visualise replications for throughput and utilisation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">summ</span> <span class="o">=</span> <span class="n">m_results</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">m_results</span><span class="p">[</span><span class="s1">&#39;primary_bed_utilisation&#39;</span><span class="p">]);</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Primary bed utilisation&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">m_results</span><span class="p">[</span><span class="s1">&#39;revision_bed_utilisation&#39;</span><span class="p">]);</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Revision bed utilisation&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">m_results</span><span class="p">[</span><span class="s1">&#39;primary_throughput&#39;</span><span class="p">]);</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Primary throughput&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">m_results</span><span class="p">[</span><span class="s1">&#39;revision_throughput&#39;</span><span class="p">]);</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Revision throughput&#39;</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">summ</span><span class="p">,</span> <span class="n">fig</span><span class="p">)</span>

<span class="c1">#summary_over_runs(m_results)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="summary-results-per-day-for-multiple-runs-for-bed-utilisation">
<h2>10. Summary results per day for multiple runs for bed utilisation<a class="headerlink" href="#summary-results-per-day-for-multiple-runs-for-bed-utilisation" title="Permalink to this headline">#</a></h2>
<p>Group by simulation time (day) across all runs</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">daily_summ_bed_utilisation</span><span class="p">(</span><span class="n">m_day_results</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    summarise per day across runs and save to csv in case of further analysis</span>
<span class="sd">    print bed utilisation plot</span>
<span class="sd">    warm-up results are excluded at runtime</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m_day_results_ts</span> <span class="o">=</span> <span class="n">m_day_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;sim_time&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">m_day_results_ts</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;data_summaries/audit_day_results_across_runs.csv&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m_day_results_ts</span><span class="p">[</span><span class="s1">&#39;bed_utilisation&#39;</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Bed Utilisation across model runtime (days)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Mean daily proportion of bed utilisation&#39;</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="summary-results-per-day-for-multiple-runs">
<h2>11. Summary results per day for multiple runs<a class="headerlink" href="#summary-results-per-day-for-multiple-runs" title="Permalink to this headline">#</a></h2>
<p>Group by weekday</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">weekly_summ_bed_utilisation</span><span class="p">(</span><span class="n">m_day_results</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    summarise per week across runs and save to csv in case of further analysis</span>
<span class="sd">    print bed utilisation plot</span>
<span class="sd">    warm-up results are excluded at runtime</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m_day_results_wd</span> <span class="o">=</span> <span class="n">m_day_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;weekday&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">m_day_results_wd</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;data_summaries/audit_weekday_results_across_runs.csv&#39;</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">m_day_results_wd</span><span class="p">[</span><span class="s1">&#39;bed_utilisation&#39;</span><span class="p">]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Monday&#39;</span><span class="p">,</span> <span class="s1">&#39;Tuesday&#39;</span><span class="p">,</span> <span class="s1">&#39;Wednesday&#39;</span><span class="p">,</span> <span class="s1">&#39;Thursday&#39;</span><span class="p">,</span> <span class="s1">&#39;Friday&#39;</span><span class="p">,</span> <span class="s1">&#39;Saturday&#39;</span><span class="p">,</span> <span class="s1">&#39;Sunday&#39;</span><span class="p">]</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Mean bed Utilisation per day of week&#39;</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="patient-level-results-summarised-by-day-and-weekday">
<h2>12. Patient level results summarised by day and weekday<a class="headerlink" href="#patient-level-results-summarised-by-day-and-weekday" title="Permalink to this headline">#</a></h2>
<p>Lost slots calculation and plots per day and weekday</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calc_lost_theatre_slots</span><span class="p">(</span><span class="n">primary_pt_results</span><span class="p">,</span> <span class="n">revision_pt_results</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Join pt dataframes into single df</span>
<span class="sd">    Select columns for lost slots</span>
<span class="sd">    Summarise by day across runs</span>
<span class="sd">    Deal with 0-day arrivals</span>
<span class="sd">    Save to csv</span>
<span class="sd">    Return lost_slots_df</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pt_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">primary_pt_results</span><span class="p">,</span> <span class="n">revision_pt_results</span><span class="p">])</span>
    <span class="n">lost_slots_df</span> <span class="o">=</span> <span class="n">pt_results</span><span class="p">[[</span><span class="s2">&quot;Day&quot;</span><span class="p">,</span> <span class="s2">&quot;lost slots&quot;</span><span class="p">,</span> <span class="s2">&quot;weekday&quot;</span><span class="p">]]</span>
    <span class="n">lost_slots_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">lost_slots_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Day&#39;</span><span class="p">,</span> <span class="s1">&#39;weekday&#39;</span><span class="p">])[</span><span class="s1">&#39;lost slots&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
    <span class="n">lost_slots_df</span> <span class="o">=</span> <span class="n">lost_slots_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">DayLostSlots</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;lost slots&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">DEFAULT_NUMBER_OF_RUNS</span><span class="p">))</span>
    <span class="n">lost_slots_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">lost_slots_df</span><span class="p">[</span><span class="s2">&quot;DayLostSlots&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    
    <span class="c1">#0-arrival days excluded from df - add to Days sequence and fill lost slots value with 0 lost slots</span>
    <span class="c1"># re-index as dataframe length increasing. Fill values in columns with 0.</span>
    <span class="n">lost_slots_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">lost_slots_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Day&#39;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">lost_slots_df</span><span class="o">.</span><span class="n">Day</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lost_slots_df</span><span class="o">.</span><span class="n">Day</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
     <span class="o">.</span><span class="n">reset_index</span><span class="p">())</span>
    
    <span class="c1">#change 0 weekdays into correct weekday integer</span>
    <span class="c1">#need days of week seq and length of total range &gt; length of dataframe</span>
    <span class="n">shortseq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">)))</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lost_slots_df</span><span class="p">)</span> <span class="o">/</span> <span class="mi">7</span><span class="p">)</span>
    
    <span class="c1">#create total sequence and flatten array list into list of elements</span>
    <span class="n">sequence</span> <span class="o">=</span> <span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">((</span><span class="n">shortseq</span><span class="p">),</span><span class="n">length</span><span class="p">)])</span>
    <span class="n">flat_seq</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">sequence</span><span class="p">))</span>
    
    <span class="c1">#truncate to correct length and save to column</span>
    <span class="n">sequence</span> <span class="o">=</span> <span class="n">flat_seq</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">lost_slots_df</span><span class="p">)]</span>
    <span class="n">lost_slots_df</span><span class="p">[</span><span class="s1">&#39;weekday&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence</span>
    <span class="n">lost_slots_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;data_summaries/Lost_slots_results_per_day.csv&#39;</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">lost_slots_df</span><span class="p">))</span>


<span class="c1">#lost_slots_df = calc_lost_theatre_slots(m_primary_pt_results, m_revision_pt_results)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_lost_slots_per_day</span><span class="p">(</span><span class="n">lost_slots_df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove warm-up period results</span>
<span class="sd">    Plot lost slots per day</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lost_slots_df</span> <span class="o">=</span> <span class="n">lost_slots_df</span><span class="p">[</span><span class="n">lost_slots_df</span><span class="p">[</span><span class="s2">&quot;Day&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">DEFAULT_WARM_UP_PERIOD</span><span class="p">]</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lost_slots_df</span><span class="p">[</span><span class="s1">&#39;DayLostSlots&#39;</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Lost theatre slots across model runtime (days)&#39;</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    

<span class="c1">#plot_lost_slots_per_day(lost_slots_df);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_lost_slots_per_week</span><span class="p">(</span><span class="n">lost_slots_df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove warm-up period results</span>
<span class="sd">    Group by week</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lost_slots_df</span> <span class="o">=</span> <span class="n">lost_slots_df</span><span class="p">[</span><span class="n">lost_slots_df</span><span class="p">[</span><span class="s2">&quot;Day&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">DEFAULT_WARM_UP_PERIOD</span><span class="p">]</span>    
    <span class="n">lost_slots_wk_plot</span> <span class="o">=</span> <span class="n">lost_slots_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;weekday&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">lost_slots_wk_plot</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">lost_slots_wk_plot</span><span class="p">[</span><span class="s1">&#39;DayLostSlots&#39;</span><span class="p">]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Monday&#39;</span><span class="p">,</span> <span class="s1">&#39;Tuesday&#39;</span><span class="p">,</span> <span class="s1">&#39;Wednesday&#39;</span><span class="p">,</span> <span class="s1">&#39;Thursday&#39;</span><span class="p">,</span> <span class="s1">&#39;Friday&#39;</span><span class="p">,</span> <span class="s1">&#39;Saturday&#39;</span><span class="p">,</span> <span class="s1">&#39;Sunday&#39;</span><span class="p">]</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Mean lost slots per day of week&#39;</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

<span class="c1">#plot_lost_slots_per_week(lost_slots_df);</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="more-plots">
<h2>13. MORE plots<a class="headerlink" href="#more-plots" title="Permalink to this headline">#</a></h2>
<p>Determine appropriate replications</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#calc means of multiple reps by rep</span>
<span class="n">more_plot_results</span> <span class="o">=</span> <span class="n">m_day_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;run&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">more_plot_results_</span> <span class="o">=</span> <span class="n">more_plot_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;bed_utilisation&#39;</span><span class="p">,</span><span class="s1">&#39;primary_bed_queue&#39;</span><span class="p">,</span> <span class="s1">&#39;revision_bed_queue&#39;</span><span class="p">,</span> 
                                                <span class="s1">&#39;primary_mean_los&#39;</span><span class="p">,</span> <span class="s1">&#39;revision_mean_los&#39;</span><span class="p">]]</span> 
<span class="n">more_plot_results_</span> <span class="o">=</span> <span class="n">more_plot_results_</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="n">more_plot_results_</span> <span class="o">*=</span> <span class="mi">100</span>
<span class="n">more_plot_results_</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
<span class="n">more_plot_results_</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># more_plot_results_.head()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ci_for_sample_mean</span><span class="p">(</span><span class="n">mean_value</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">critical_value</span><span class="o">=</span><span class="mf">1.96</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Confidence interval for mean.  Assume std is sample std.</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    </span>
<span class="sd">    critical value hard coded at the moment.  </span>
<span class="sd">    Should update to use t dist.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">half_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">critical_value</span> <span class="o">*</span> <span class="p">(</span><span class="n">std</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>
    <span class="n">mean_lower</span> <span class="o">=</span> <span class="n">mean_value</span> <span class="o">-</span> <span class="n">half_width</span>
    <span class="n">mean_upper</span> <span class="o">=</span> <span class="n">mean_value</span> <span class="o">+</span> <span class="n">half_width</span>
    <span class="k">return</span> <span class="n">mean_lower</span><span class="p">,</span> <span class="n">mean_upper</span>

<span class="k">def</span> <span class="nf">ci_percentile</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">percentile</span><span class="p">,</span> <span class="n">critical_value</span><span class="o">=</span><span class="mf">1.96</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Approximate confidence interval for percentile.</span>
<span class="sd">    Note these may or may not be symmetric.</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    </span>
<span class="sd">    critical value hard coded at the moment.  </span>
<span class="sd">    Should update to use t dist.</span>
<span class="sd">    </span>
<span class="sd">    Params:</span>
<span class="sd">    ------</span>
<span class="sd">    results: pd.DataFrame</span>
<span class="sd">        Results dataframe - tabular data where each row is a rep and each col is a KPI</span>
<span class="sd">        </span>
<span class="sd">    field: int</span>
<span class="sd">        Field from data frame to analyse</span>
<span class="sd">        </span>
<span class="sd">    percentile: float</span>
<span class="sd">        The percentile around which to form the CI</span>
<span class="sd">        </span>
<span class="sd">    critical_value: float, optional (default = 1.96)</span>
<span class="sd">        critical value of the normal dist to use.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">half_width</span> <span class="o">=</span> <span class="n">critical_value</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">percentile</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">percentile</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">y_beta_1</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">percentile</span> <span class="o">-</span> <span class="n">half_width</span><span class="p">)</span>
    <span class="n">y_beta_2</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">percentile</span> <span class="o">+</span> <span class="n">half_width</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y_beta_1</span><span class="p">,</span> <span class="n">y_beta_2</span>

<span class="k">def</span> <span class="nf">as_horizontal_axis_fraction</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Convert a axis value to a fraction accounting for the </span>
<span class="sd">    minimum on the xaxis (i.e. axis may not start from 0).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">draw_interval</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;|-|&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Annotate a matplotlib chart underneath x axis with an confidence interval.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span> 
                       <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">),</span>
                       <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">more_plot</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">percentiles</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span> <span class="n">surpress_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Measure of Risk and Error (MORE) plot.</span>
<span class="sd">    </span>
<span class="sd">    Risk illustrated via likely and unlikely ranges of replication values. </span>
<span class="sd">    Erorr illustrated for CIs for mean and wide approx confidence intervals for percentiles</span>
<span class="sd">        </span>
<span class="sd">    Confidence intervals for percentiles will only be calculated if &gt; 80 replications due to </span>
<span class="sd">    approximation accuracy.</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    Each value plotted represents the mean of a replication (e.g. daily throughput).  It should</span>
<span class="sd">    not be confused with an individuals results (e.g. an individuals throughput time). </span>
<span class="sd">    </span>
<span class="sd">    If the system modelled contains time dependency the MORE plot may hide time of day/event effects.</span>
<span class="sd">    </span>
<span class="sd">    Params:</span>
<span class="sd">    ------</span>
<span class="sd">    results: pd.DataFrame</span>
<span class="sd">        Tabular data of replications. each column is a kpi</span>
<span class="sd">        </span>
<span class="sd">    field: int</span>
<span class="sd">        ID of column containing relevant data</span>
<span class="sd">        </span>
<span class="sd">    bins: int, optional (default=None)</span>
<span class="sd">        no. bins to generate. None=pandas decides no.</span>
<span class="sd">        </span>
<span class="sd">    figsize: tuple, optional (default=(8,5))</span>
<span class="sd">        size of plot</span>
<span class="sd">        </span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    -------</span>
<span class="sd">    fig, ax</span>
<span class="sd">    </span>
<span class="sd">    Refs:</span>
<span class="sd">    -----</span>
<span class="sd">    </span>
<span class="sd">    Nelson 2008. (Winter Simulation Paper)</span>
<span class="sd">    https://ieeexplore.ieee.org/document/4736095    </span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1"># probably will shift these to module level scope.</span>
    <span class="n">LIKELY</span> <span class="o">=</span> <span class="s1">&#39;LIKELY&#39;</span>
    <span class="n">UNLIKELY</span> <span class="o">=</span> <span class="s1">&#39;UNLIKELY&#39;</span>
    <span class="n">FONT_SIZE</span> <span class="o">=</span> <span class="mi">12</span>
    <span class="n">LINE_WIDTH</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">LINE_STYLE</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
    <span class="n">CRIT_VALUE</span> <span class="o">=</span> <span class="mf">1.96</span>
    <span class="n">UPPER_QUANTILE</span> <span class="o">=</span> <span class="n">percentiles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">LOWER_QUANTILE</span> <span class="o">=</span> <span class="n">percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">INTERVAL_LW</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">MIN_N_FOR_PERCENTILE</span> <span class="o">=</span> <span class="mi">80</span>
    <span class="n">WARN</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;CIs for percentiles are not generated as sample size &lt; </span><span class="si">{</span><span class="n">MIN_N_FOR_PERCENTILE</span><span class="si">}</span><span class="s1">.&#39;</span>
    <span class="n">WARN</span> <span class="o">+=</span> <span class="s1">&#39; To supress this msg set `supress_warnings=True`&#39;</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">upper_percentile</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">UPPER_QUANTILE</span><span class="p">)</span>
    <span class="n">lower_percentile</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">LOWER_QUANTILE</span><span class="p">)</span>

    <span class="c1"># vertical lines</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">LINE_WIDTH</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">upper_percentile</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">LINE_WIDTH</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">lower_percentile</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">LINE_WIDTH</span><span class="p">)</span>

    <span class="n">like_font</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;serif&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;color&#39;</span><span class="p">:</span>  <span class="s1">&#39;black&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">FONT_SIZE</span>
                 <span class="p">}</span>
    <span class="n">unlike_font</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;serif&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;color&#39;</span><span class="p">:</span>  <span class="s1">&#39;red&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">FONT_SIZE</span>
                 <span class="p">}</span>

    <span class="c1"># add text</span>
    <span class="n">txt_offset</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.05</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">mean</span> <span class="o">-</span> <span class="p">(</span><span class="n">mean</span> <span class="o">*</span> <span class="mf">0.001</span><span class="p">),</span> <span class="n">txt_offset</span><span class="p">,</span> <span class="n">LIKELY</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">like_font</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">upper_percentile</span><span class="p">,</span> <span class="n">txt_offset</span><span class="p">,</span> <span class="n">UNLIKELY</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">unlike_font</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">txt_offset</span><span class="p">,</span> <span class="n">UNLIKELY</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">unlike_font</span><span class="p">)</span>

    <span class="c1"># calculate and display confidence intervals</span>

    <span class="c1">## CIs for sample mean</span>
    <span class="n">mean_lower</span><span class="p">,</span> <span class="n">mean_upper</span> <span class="o">=</span> <span class="n">ci_for_sample_mean</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
    
    <span class="c1"># Draw Confidence intervals</span>
    <span class="c1"># The horizontal lines are expressed as an axis fraction i.e. between 0 and 1.  </span>
    <span class="c1"># This means thatthe percentile CIs need to be converted before plotting.</span>
    <span class="c1"># The function as_horizontal_axis_fraction is used.</span>

    <span class="c1">## mean CI  </span>
    <span class="n">hline_mean_from</span> <span class="o">=</span> <span class="n">as_horizontal_axis_fraction</span><span class="p">(</span><span class="n">mean_lower</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">hline_mean_to</span> <span class="o">=</span> <span class="n">as_horizontal_axis_fraction</span><span class="p">(</span><span class="n">mean_upper</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">draw_interval</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">hline_mean_from</span><span class="p">,</span> <span class="n">hline_mean_to</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">INTERVAL_LW</span><span class="p">)</span>
    
    <span class="c1"># avoid approximation issues with small samples.  </span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MIN_N_FOR_PERCENTILE</span><span class="p">:</span>
        <span class="c1">## upper percentile</span>
        <span class="n">y_beta_1</span><span class="p">,</span> <span class="n">y_beta_2</span> <span class="o">=</span> <span class="n">ci_percentile</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">UPPER_QUANTILE</span><span class="p">,</span> <span class="n">critical_value</span><span class="o">=</span><span class="n">CRIT_VALUE</span><span class="p">)</span>

        <span class="c1">## lower percentile</span>
        <span class="n">y_beta_l_1</span><span class="p">,</span> <span class="n">y_beta_l_2</span> <span class="o">=</span> <span class="n">ci_percentile</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">LOWER_QUANTILE</span><span class="p">,</span> <span class="n">critical_value</span><span class="o">=</span><span class="n">CRIT_VALUE</span><span class="p">)</span>
        
        <span class="c1">## line for upper quantile CI</span>
        <span class="n">hline_upper_q_from</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_beta_1</span> <span class="o">-</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">hline_upper_q_to</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_beta_2</span> <span class="o">-</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="n">hline_upper_q_from</span> <span class="o">=</span> <span class="n">as_horizontal_axis_fraction</span><span class="p">(</span><span class="n">y_beta_1</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">hline_upper_q_to</span> <span class="o">=</span> <span class="n">as_horizontal_axis_fraction</span><span class="p">(</span><span class="n">y_beta_2</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">draw_interval</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">hline_upper_q_from</span><span class="p">,</span> <span class="n">hline_upper_q_to</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">INTERVAL_LW</span><span class="p">)</span>
        
        <span class="c1">## line for lower quantile CI</span>
        <span class="n">hline_lower_q_from</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_beta_l_1</span> <span class="o">-</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">hline_lower_q_to</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_beta_l_2</span> <span class="o">-</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="n">hline_lower_q_from</span> <span class="o">=</span> <span class="n">as_horizontal_axis_fraction</span><span class="p">(</span><span class="n">y_beta_l_1</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">hline_lower_q_to</span> <span class="o">=</span> <span class="n">as_horizontal_axis_fraction</span><span class="p">(</span><span class="n">y_beta_l_2</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">draw_interval</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">hline_lower_q_from</span><span class="p">,</span> <span class="n">hline_lower_q_to</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">INTERVAL_LW</span><span class="p">)</span>
        
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">surpress_warnings</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">WARN</span><span class="p">)</span>
        
    
    <span class="k">return</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="p">,</span> <span class="n">ax</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">more_plot_results_</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">more_plot</span><span class="p">(</span><span class="n">results</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_254019/625959835.py:126: UserWarning: CIs for percentiles are not generated as sample size &lt; 80. To supress this msg set `supress_warnings=True`
  warnings.warn(WARN)
</pre></div>
</div>
<img alt="../../_images/704dbb9bfc2065ed895cb394242acf93a2dd7334d015aa17844cd2234d3bc770.png" src="../../_images/704dbb9bfc2065ed895cb394242acf93a2dd7334d015aa17844cd2234d3bc770.png" />
</div>
</div>
</section>
<section id="hists-of-outputs">
<h2>hists of outputs<a class="headerlink" href="#hists-of-outputs" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">more_plot_results</span> <span class="o">=</span> <span class="n">m_day_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;run&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">hist_results</span> <span class="o">=</span> <span class="n">more_plot_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;bed_utilisation&#39;</span><span class="p">,</span> <span class="s1">&#39;primary_bed_queue&#39;</span><span class="p">,</span> <span class="s1">&#39;revision_bed_queue&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;primary_mean_los&#39;</span><span class="p">,</span> <span class="s1">&#39;revision_mean_los&#39;</span><span class="p">]]</span> 

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">hist_results</span><span class="p">[</span><span class="s1">&#39;bed_utilisation&#39;</span><span class="p">]);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;bed utilisation&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">hist_results</span><span class="p">[</span><span class="s1">&#39;primary_bed_queue&#39;</span><span class="p">]);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;primary_bed_queue&#39;</span><span class="p">);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">hist_results</span><span class="p">[</span><span class="s1">&#39;revision_bed_queue&#39;</span><span class="p">]);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;revision_bed_queue&#39;</span><span class="p">);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">hist_results</span><span class="p">[</span><span class="s1">&#39;primary_mean_los&#39;</span><span class="p">]);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;primary_bed_queue&#39;</span><span class="p">);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">hist_results</span><span class="p">[</span><span class="s1">&#39;revision_mean_los&#39;</span><span class="p">]);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;revision_mean_los&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/91b5f4fab54c89e5ba19c7165cf1114938e8a6418c806d66f336360b0d192d2f.png" src="../../_images/91b5f4fab54c89e5ba19c7165cf1114938e8a6418c806d66f336360b0d192d2f.png" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./HEP_notebooks/01_model"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="../01_intro.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Hospital Efficiency Project</p>
      </div>
    </a>
    <a class="right-next"
       href="02_Scenario_testing.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Scenario Testing</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#packages">1. Packages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#baseline-parameters">2. Baseline parameters</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#initialise-start-date">2.1 Initialise start date</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fitted-baseline-parameters-for-nbt-based-on-electronic-health-records-2016-2019">2.2 Fitted baseline parameters for NBT based on electronic health records 2016-2019</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">2.3 Baseline parameters</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#trace-utility">3. Trace utility</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#distribution-classes">4. Distribution classes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#theatre-schedule">4. Theatre schedule</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-parameterisation">5. Model parameterisation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#patient-pathways-process-logic">6. Patient pathways process logic</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-model-class">7. The model class</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary-results-across-days-and-runs">8. Summary results across days and runs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-execution">9. Model execution</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-single-run">9.1 A single run</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multiple-independent-replications">9.2 Multiple independent replications</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-summary-results-for-multiple-runs">9.3 Plot summary results for multiple runs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary-results-per-day-for-multiple-runs-for-bed-utilisation">10. Summary results per day for multiple runs for bed utilisation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary-results-per-day-for-multiple-runs">11. Summary results per day for multiple runs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#patient-level-results-summarised-by-day-and-weekday">12. Patient level results summarised by day and weekday</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#more-plots">13. MORE plots</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hists-of-outputs">hists of outputs</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Alison Harper, Thomas Monks, Martin Pitt
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
       Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>